<!DOCTYPE html>
<html>
<head>
    <title>Printer Client</title>
</head>
<body>
    <div id="app">
        <h1>Printer Service</h1>
        <button onclick="getPrinters()">Get Printers</button>
        <div id="printers"></div>
        <div id="status"></div>
    </div>

    <script>
        let ws = null;
        
        function connect() {
            ws = new WebSocket('ws://localhost:8081/ws');
            
            ws.onopen = function() {
                console.log('Connected to printer service');
                document.getElementById('status').innerHTML = 'Connected';
            };
            
            ws.onmessage = function(event) {
                console.log('Raw message received:', event.data);
                let data;
                try {
                    data = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;
                } catch (e) {
                    console.error('Failed to parse message:', e, event.data);
                    return;
                }
                handleMessage(data);
            };
            
            ws.onclose = function() {
                console.log('Disconnected');
                document.getElementById('status').innerHTML = 'Disconnected';
                // Attempt to reconnect after 3 seconds
                setTimeout(connect, 3000);
            };
        }
        
        function handleMessage(msg) {
            console.log('Handling message:', msg);
            switch(msg.type) {
                case 'printers_list':
                    // Payload is already an array of printer objects
                    displayPrinters(msg.payload);
                    break;
                case 'print_success':
                    // Payload is already an object with jobId
                    alert('Print job completed: ' + msg.payload.jobId);
                    break;
                case 'escpos_print_success':
                    // ESC/POS print success
                    alert('ESC/POS Print job completed: ' + msg.payload.jobId);
                    break;
                case 'raw_escpos_print_success':
                    // Raw ESC/POS print success
                    alert('Raw ESC/POS Print job completed: ' + msg.payload.jobId);
                    break;
                case 'error':
                    // Payload is already an object with message
                    alert('Error: ' + msg.payload.message);
                    break;
                default:
                    console.log('Unknown message type:', msg.type);
            }
        }
        
        function getPrinters() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({type: 'get_printers'}));
            }
        }
        
        function displayPrinters(printers) {
            const container = document.getElementById('printers');
            container.innerHTML = '<h3>Available Printers:</h3>';
            
            printers.forEach(printer => {
                const printerDiv = document.createElement('div');
                printerDiv.innerHTML = `
                    <p><strong>${printer.name}</strong> - ${printer.status} 
                    ${printer.default ? '(Default)' : ''}
                    <button onclick="printTest('${printer.name}')">Print Test (Text)</button>
                    <button onclick="printEscPosTest('${printer.name}')">Print Test (ESC/POS Backend)</button>
                    <button onclick="printRawEscPosTest('${printer.name}')">Print Test (ESC/POS Frontend)</button>
                    </p>
                `;
                container.appendChild(printerDiv);
            });
        }
        
        function printTest(printerName) {
            // Create a professional POS bill format
            const now = new Date();
            const date = now.toLocaleDateString();
            const time = now.toLocaleTimeString();
            const billNo = 'BILL-' + Date.now().toString().slice(-6);
            
            const content = 
`========================================
           RESTAURANT RECEIPT
========================================
Date: ${date}                Time: ${time}
Bill No: ${billNo}          Table: 05
Cashier: John Smith         Terminal: ${printerName}
----------------------------------------
ITEM                  QTY   RATE  AMOUNT
----------------------------------------
1. Margherita Pizza    1   $12.99  $12.99
2. Caesar Salad        1    $8.50   $8.50
3. Chicken Wings       2    $7.25  $14.50
4. Garlic Bread        1    $4.99   $4.99
5. Coca Cola           3    $2.50   $7.50
6. Beef Burger         1   $15.99  $15.99
7. French Fries        2    $3.99   $7.98
8. Chocolate Cake      1    $6.50   $6.50
9. Iced Coffee         2    $3.75   $7.50
10. Fish & Chips       1   $13.99  $13.99
----------------------------------------
SUBTOTAL                           $100.44
Tax (8.5%)                          $8.54
Service Charge (10%)               $10.04
----------------------------------------
TOTAL AMOUNT                      $119.02
----------------------------------------
PAYMENT METHOD: CASH
CASH RECEIVED:                    $120.00
CHANGE:                             $0.98
----------------------------------------
        ⭐ THANK YOU FOR VISITING! ⭐
         Visit us again soon!
      Follow us @restaurant_social
========================================
    Customer Copy - Please keep this
         receipt for your records
========================================`;
            
            const printJob = {
                printerName: printerName,
                content: content,
                jobId: 'test-' + Date.now()
            };
            
            console.log('Sending print job:', printJob);
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'print',
                    payload: printJob  // Send as object, not stringified
                }));
            }
        }
        
        function printEscPosTest(printerName) {
            // Create sample invoice data for ESC/POS testing
            const now = new Date();
            const invoiceCode = 'INV-' + Date.now().toString().slice(-6);
            const currentDateTime = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
            
            const escPosJob = {
                printerName: printerName,
                jobId: 'escpos-test-' + Date.now(),
                format: 'escpos',
                data: {
                    invoiceCode: invoiceCode,
                    tableNumber: '15',
                    currentDateTime: currentDateTime,
                    items: [
                        {
                            name: 'Margherita Pizza',
                            quantity: 1,
                            price: 12.99
                        },
                        {
                            name: 'Caesar Salad',
                            quantity: 1,
                            price: 8.50
                        },
                        {
                            name: 'Chicken Wings',
                            quantity: 2,
                            price: 7.25
                        },
                        {
                            name: 'Garlic Bread',
                            quantity: 1,
                            price: 4.99
                        },
                        {
                            name: 'Coca Cola',
                            quantity: 3,
                            price: 2.50
                        },
                        {
                            name: 'Beef Burger',
                            quantity: 1,
                            price: 15.99
                        },
                        {
                            name: 'French Fries',
                            quantity: 2,
                            price: 3.99
                        },
                        {
                            name: 'Chocolate Cake',
                            quantity: 1,
                            price: 6.50
                        }
                    ],
                    subtotal: 95.46,
                    discount: '5.00',
                    serviceFee: '9.55',
                    grandTotal: 100.01,
                    cashPaid: '105.00',
                    customerBalance: 4.99
                }
            };
            
            console.log('Sending ESC/POS print job:', escPosJob);
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'print_escpos',
                    payload: escPosJob
                }));
            }
        }
        
        // ESC/POS Command constants for 80mm thermal printer
        const ESC_POS = {
            ESC: '\x1b',
            GS: '\x1d',
            
            // Commands
            INIT: '\x1b@',
            BOLD_ON: '\x1bE\x01',
            BOLD_OFF: '\x1bE\x00',
            UNDERLINE_ON: '\x1b-\x01',
            UNDERLINE_OFF: '\x1b-\x00',
            
            ALIGN_LEFT: '\x1ba\x00',
            ALIGN_CENTER: '\x1ba\x01',
            ALIGN_RIGHT: '\x1ba\x02',
            
            SIZE_NORMAL: '\x1d!\x00',
            SIZE_DOUBLE_HEIGHT: '\x1d!\x01',
            SIZE_DOUBLE_WIDTH: '\x1d!\x10',
            SIZE_DOUBLE_BOTH: '\x1d!\x11',
            
            // Font selection for 80mm width optimization
            FONT_A: '\x1bM\x00', // 12x24 dots, 42-48 chars/line
            FONT_B: '\x1bM\x01', // 9x17 dots, 56-64 chars/line
            FONT_C: '\x1bM\x02', // 9x24 dots, 56-64 chars/line
            
            // Character spacing
            CHAR_SPACING_0: '\x1b \x00',
            CHAR_SPACING_1: '\x1b \x01',
            
            LINE_FEED: '\n',
            CUT_PAPER: '\x1dV\x41\x00', // Partial cut
            FULL_CUT: '\x1dV\x00',
            
            // Paper width constants for 80mm
            PAPER_WIDTH: 48, // Characters per line for normal font
            SEPARATOR_CHAR: '-'
        };
        
        function createInvoiceEscPos(invoiceData) {
            let escpos = '';
            const width = ESC_POS.PAPER_WIDTH;
            const separator = ESC_POS.SEPARATOR_CHAR.repeat(width);
            
            // Initialize printer
            escpos += ESC_POS.INIT;
            escpos += ESC_POS.FONT_A; // Set to Font A for optimal 80mm width
            
            // Header - Center aligned, bold, double height
            escpos += ESC_POS.ALIGN_CENTER;
            escpos += ESC_POS.BOLD_ON;
            escpos += ESC_POS.SIZE_DOUBLE_HEIGHT;
            escpos += 'RESTAURANT RECEIPT';
            escpos += ESC_POS.LINE_FEED;
            escpos += ESC_POS.SIZE_NORMAL;
            escpos += ESC_POS.BOLD_OFF;
            escpos += ESC_POS.LINE_FEED;
            
            // Restaurant name and details
            escpos += ESC_POS.ALIGN_CENTER;
            escpos += 'THE GREAT RESTAURANT';
            escpos += ESC_POS.LINE_FEED;
            escpos += '123 Main Street, City';
            escpos += ESC_POS.LINE_FEED;
            escpos += 'Phone: (555) 123-4567';
            escpos += ESC_POS.LINE_FEED;
            escpos += ESC_POS.LINE_FEED;
            
            // Invoice details
            escpos += ESC_POS.ALIGN_LEFT;
            escpos += separator;
            escpos += ESC_POS.LINE_FEED;
            escpos += `Invoice: ${invoiceData.invoiceCode}`;
            escpos += ESC_POS.LINE_FEED;
            escpos += `Table: ${invoiceData.tableNumber}`;
            escpos += ESC_POS.LINE_FEED;
            escpos += `Date: ${invoiceData.currentDateTime}`;
            escpos += ESC_POS.LINE_FEED;
            escpos += 'Cashier: John Smith';
            escpos += ESC_POS.LINE_FEED;
            escpos += separator;
            escpos += ESC_POS.LINE_FEED;
            
            // Items header - optimized for 80mm (48 chars)
            escpos += ESC_POS.BOLD_ON;
            escpos += 'ITEM                        QTY  PRICE';
            escpos += ESC_POS.LINE_FEED;
            escpos += ESC_POS.BOLD_OFF;
            escpos += separator;
            escpos += ESC_POS.LINE_FEED;
            
            // Items - optimized spacing for 80mm
            invoiceData.items.forEach((item, index) => {
                let itemName = item.name;
                if (itemName.length > 26) {
                    itemName = itemName.substring(0, 23) + '...';
                }
                
                // Format: Item name (26 chars) + Qty (3 chars) + Price (8 chars) = 37 chars
                const line = `${(index + 1).toString().padStart(2, '0')}. ${itemName.padEnd(24, ' ')} ${item.quantity.toString().padStart(2, ' ')} ${item.price.toFixed(2).padStart(6, ' ')}`;
                escpos += line;
                escpos += ESC_POS.LINE_FEED;
            });
            
            // Separator
            escpos += separator;
            escpos += ESC_POS.LINE_FEED;
            
            // Totals - right aligned for 80mm
            escpos += `Subtotal:${('$' + invoiceData.subtotal.toFixed(2)).padStart(width - 9, ' ')}`;
            escpos += ESC_POS.LINE_FEED;
            escpos += `Discount:${('$' + invoiceData.discount).padStart(width - 9, ' ')}`;
            escpos += ESC_POS.LINE_FEED;
            escpos += `Service Fee:${('$' + invoiceData.serviceFee).padStart(width - 12, ' ')}`;
            escpos += ESC_POS.LINE_FEED;
            escpos += separator;
            escpos += ESC_POS.LINE_FEED;
            
            // Grand total - bold and centered
            escpos += ESC_POS.BOLD_ON;
            const totalText = `TOTAL: $${invoiceData.grandTotal.toFixed(2)}`;
            escpos += ESC_POS.ALIGN_CENTER;
            escpos += ESC_POS.SIZE_DOUBLE_WIDTH;
            escpos += totalText;
            escpos += ESC_POS.LINE_FEED;
            escpos += ESC_POS.SIZE_NORMAL;
            escpos += ESC_POS.BOLD_OFF;
            escpos += ESC_POS.ALIGN_LEFT;
            escpos += separator;
            escpos += ESC_POS.LINE_FEED;
            
            // Payment info
            escpos += `Cash Paid:${('$' + invoiceData.cashPaid).padStart(width - 10, ' ')}`;
            escpos += ESC_POS.LINE_FEED;
            escpos += `Change:${('$' + invoiceData.customerBalance.toFixed(2)).padStart(width - 7, ' ')}`;
            escpos += ESC_POS.LINE_FEED;
            escpos += ESC_POS.LINE_FEED;
            
            // Footer
            escpos += ESC_POS.ALIGN_CENTER;
            escpos += separator;
            escpos += ESC_POS.LINE_FEED;
            escpos += ESC_POS.BOLD_ON;
            escpos += '★ THANK YOU FOR VISITING! ★';
            escpos += ESC_POS.LINE_FEED;
            escpos += ESC_POS.BOLD_OFF;
            escpos += 'Please visit us again soon!';
            escpos += ESC_POS.LINE_FEED;
            escpos += 'Follow us @restaurant_social';
            escpos += ESC_POS.LINE_FEED;
            escpos += separator;
            escpos += ESC_POS.LINE_FEED;
            escpos += ESC_POS.LINE_FEED;
            escpos += 'Customer Copy';
            escpos += ESC_POS.LINE_FEED;
            escpos += 'Please keep for your records';
            escpos += ESC_POS.LINE_FEED;
            escpos += ESC_POS.LINE_FEED;
            escpos += ESC_POS.LINE_FEED;
            
            // Cut paper
            escpos += ESC_POS.CUT_PAPER;
            
            return escpos;
        }
        
        function printRawEscPosTest(printerName) {
            // Create sample invoice data
            const now = new Date();
            const invoiceData = {
                invoiceCode: 'INV-' + Date.now().toString().slice(-6),
                tableNumber: '15',
                currentDateTime: now.toLocaleDateString() + ' ' + now.toLocaleTimeString(),
                items: [
                    { name: 'Margherita Pizza', quantity: 1, price: 12.99 },
                    { name: 'Caesar Salad', quantity: 1, price: 8.50 },
                    { name: 'Chicken Wings', quantity: 2, price: 7.25 },
                    { name: 'Garlic Bread', quantity: 1, price: 4.99 },
                    { name: 'Coca Cola', quantity: 3, price: 2.50 },
                    { name: 'Beef Burger Deluxe', quantity: 1, price: 15.99 },
                    { name: 'French Fries', quantity: 2, price: 3.99 },
                    { name: 'Chocolate Cake', quantity: 1, price: 6.50 }
                ],
                subtotal: 95.46,
                discount: '5.00',
                serviceFee: '9.55',
                grandTotal: 100.01,
                cashPaid: '105.00',
                customerBalance: 4.99
            };
            
            // Generate ESC/POS commands on frontend
            const escPosCommands = createInvoiceEscPos(invoiceData);
            
            const rawEscPosJob = {
                printerName: printerName,
                jobId: 'raw-escpos-test-' + Date.now(),
                rawData: escPosCommands
            };
            
            console.log('Sending Raw ESC/POS print job:', rawEscPosJob);
            console.log('ESC/POS Commands Length:', escPosCommands.length);
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'print_raw_escpos',
                    payload: rawEscPosJob
                }));
            }
        }
        
        // Initialize connection
        connect();
    </script>
</body>
</html>